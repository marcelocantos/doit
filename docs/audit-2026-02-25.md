# doit Codebase Audit

**Commit:** `7b77daa` (untagged)
**Date:** 2026-02-25
**Auditor:** Claude Opus 4.6 (automated, 3 parallel audit agents + adversarial reviewer)
**Dirty state:** `.claude/settings.local.json` only (not project code)

---

## Action Checklist

### Critical

- [ ] **1. No LICENSE file** — Hard blocker. Code is "all rights reserved" without one. Add Apache-2.0 LICENSE.
- [ ] **2. `find -exec`/`-delete` bypasses tier system** — `find` is TierRead but `-exec`/`-delete` give unrestricted command execution. (`internal/cap/builtin/find.go:16`)

### High

- [ ] **3. `go run`/`go generate` give arbitrary code execution at build tier** — No subcommand inspection. (`internal/cap/builtin/go_cmd.go:16`)
- [ ] **4. `make -f` gives arbitrary code execution at build tier** — No argument filtering. (`internal/cap/builtin/make.go:16`)
- [ ] **5. Nil panic on Lookup failure in executor** — Error discarded; nil deref crashes process. (`internal/pipeline/executor.go:70,108`)
- [ ] **6. Five packages have zero test coverage** — `cmd/doit`, `internal/cap`, `internal/cap/builtin`, `internal/cli`, `internal/config`.

### Medium

- [ ] **7. `git stash` at TierRead but push/pop/drop mutate repo** (`internal/cap/builtin/git.go:42`)
- [ ] **8. `git config` at TierRead but can write configuration** (`internal/cap/builtin/git.go:41`)
- [ ] **9. `›` redirect performs writes without checking TierWrite** — Read-only pipeline with `›` can create/overwrite files. (`internal/pipeline/executor.go:58-65`)
- [ ] **10. Audit log: no fsync** — Entries can be lost on crash. (`internal/audit/logger.go:80-89`)
- [ ] **11. `computeHash` silently ignores `json.Marshal` error** (`internal/audit/logger.go:104`)
- [ ] **12. Audit tampering test is fragile** — Flips random byte; may test wrong error path. (`internal/audit/audit_test.go:60-65`)
- [ ] **13. Audit logging silently disabled on logger creation failure** (`cmd/doit/main.go:43-46`)
- [ ] **14. No CI pipeline** — No automated testing on push/PR.
- [ ] **15. `make install` assumes `$GOPATH` is set** — Could write to `/bin/doit`. (`Makefile:23`)
- [ ] **16. Audit log write errors silently discarded** (`internal/cli/run.go:119`)

### Low

- [ ] **17. `UserHomeDir` error silently discarded** — Broken paths if `$HOME` is unset. (`internal/config/config.go:35,79,96`)
- [ ] **18. `Verify` slices hash to 16 chars without length check** — Panic on corrupted log. (`internal/audit/verify.go:38,44`)
- [ ] **19. `ExitError.Error()` returns empty string** — Confusing when logged/wrapped. (`internal/cap/builtin/external.go:17`)
- [ ] **20. `›` redirect always truncates** — No append operator; document this.
- [ ] **21. `.gitignore` is minimal** — Missing `.DS_Store`, `*.test`, IDE files, `.claude/settings.local.json`.
- [ ] **22. `--help` for specific capability is minimal** (`internal/cli/help.go:29-31`)
- [ ] **23. `--help-agent` not listed in general `--help` output** (`internal/cli/help.go:42-64`)
- [ ] **24. `--list` alignment hardcoded** — Breaks with long names. (`internal/cli/list.go:28`)
- [ ] **25. `.claude/settings.local.json` tracked in git** — Should be gitignored.

### Info

- **26.** `MaxSizeMB` config field defined but never enforced. (`internal/config/config.go:30`)
- **27.** `Registry.All()` allocates/sorts on every call (negligible at 19 caps).
- **28.** Hash chain depends on Go's `json.Marshal` field ordering (stable in practice).
- **29.** No secrets found in git history. (positive)
- **30.** AI co-authorship properly attributed in git history. (positive)
- **31.** `gopkg.in/yaml.v3` license (MIT/Apache-2.0) compatible with Apache 2.0. (positive)

---

## Detailed Findings

### Critical

#### 1. No LICENSE file

**File:** (missing, expected at repository root)

The project is about to be open-sourced under Apache 2.0, but no LICENSE file exists. Without one, the code is "all rights reserved" by default under copyright law. GitHub and the Go module proxy rely on a LICENSE file for license detection.

**Fix:** Add the standard Apache License 2.0 text as `LICENSE` at the repository root.

#### 2. `find -exec`/`-delete` bypasses tier system

**File:** `internal/cap/builtin/find.go:16-20`

`find` is classified as `TierRead` and passes all arguments to the external `find` binary with no filtering. `find -exec rm -rf / \;` or `find -delete` would execute at read tier, completely circumventing the safety model. An agent given only read permissions can perform arbitrary writes and deletes.

**Fix:** Scan args for `-exec`, `-execdir`, `-delete`, `-ok`, `-okdir` in `Validate()` and reject or escalate tier. Alternatively, implement arg-based tier escalation similar to `gitSubcommandTier()`.

### High

#### 3. `go run`/`go generate` give arbitrary code execution at build tier

**File:** `internal/cap/builtin/go_cmd.go:16-20`

`go` is `TierBuild` with no subcommand inspection. `go run malicious.go` executes arbitrary code. Build tier is "compile," not "run arbitrary programs."

**Fix:** Add subcommand-aware tier mapping: `go build`/`go test`/`go vet`/`go mod`/`go list`/`go fmt` at TierBuild; `go run`/`go generate` at TierDangerous.

#### 4. `make -f` gives arbitrary code execution at build tier

**File:** `internal/cap/builtin/make.go:16-20`

`make` is `TierBuild` with no argument inspection. `make -f attacker.mk` can execute arbitrary shell commands via an arbitrary Makefile.

**Fix:** Block `-f`/`--file`/`--makefile` and `-C`/`--directory` in `Validate()`, or document as accepted risk of build tier.

#### 5. Nil panic on Lookup failure in executor

**File:** `internal/pipeline/executor.go:70-71` and `:108`

`c, _ := reg.Lookup(p.Segments[0].CapName)` discards the error. If Lookup returns nil, `c.Run()` panics. At line 108 this happens inside a goroutine, which crashes the entire process. While `Validate()` is typically called first, nothing enforces this.

**Fix:** Check the error from `reg.Lookup` and return it.

#### 6. Five packages have zero test coverage

`cmd/doit`, `internal/cap`, `internal/cap/builtin`, `internal/cli`, `internal/config` have no test files. The untested packages include all CLI entry points, tier checking logic, config loading, and all 19 builtin capabilities.

**Fix:** Prioritize tests for: `internal/cap` (Registry, CheckTier), `internal/cli` (RunDirect/RunPipe error paths, exit code propagation), `internal/config` (Load, tilde expansion), `internal/cap/builtin` (gitSubcommandTier, Validate methods with logic).

### Medium

#### 7. `git stash` at TierRead but push/pop/drop mutate repo

**File:** `internal/cap/builtin/git.go:42`

The comment acknowledges `stash list is read, but stash push/pop is write`, yet `stash` as a whole is TierRead.

**Fix:** Add sub-subcommand parsing: `stash list`/`stash show` = TierRead, `stash push`/`pop`/`drop`/`apply` = TierWrite.

#### 8. `git config` at TierRead but can write configuration

**File:** `internal/cap/builtin/git.go:41`

`git config user.name "evil"` or `git config --global core.hooksPath /tmp/evil` writes config at TierRead.

**Fix:** `config --get`/`--list` = TierRead; `config key value` / `config --unset` = TierWrite.

#### 9. `›` redirect performs writes without checking TierWrite

**File:** `internal/pipeline/executor.go:58-65`

`os.Create` creates/truncates files. `Validate()` only checks capability tiers, not redirects. A pipeline like `doit --pipe cat file › /etc/important` succeeds at TierRead.

**Fix:** In `Validate()`, if `p.RedirectOut != ""`, require `reg.CheckTier(TierWrite)`.

#### 10. Audit log: no fsync

**File:** `internal/audit/logger.go:80-89`

File is opened, written, and closed with no `f.Sync()`. On crash, the last entry may be lost.

**Fix:** Add `f.Sync()` after `f.Write()`.

#### 11. `computeHash` silently ignores `json.Marshal` error

**File:** `internal/audit/logger.go:104`

`data, _ := json.Marshal(e)` — if marshal fails, hash is computed over nil data. Undermines audit chain integrity.

**Fix:** Return error from `computeHash`, propagate through `Log()`.

#### 12. Audit tampering test is fragile

**File:** `internal/audit/audit_test.go:60-65`

Flips a random byte at the midpoint. If it lands on JSON structure, may test parse failure instead of hash mismatch.

**Fix:** Target a specific field (e.g., change `"exit_code":0` to `"exit_code":1`).

#### 13. Audit logging silently disabled on logger creation failure

**File:** `cmd/doit/main.go:43-46`

If logger creation fails, a warning is printed but execution continues unaudited.

**Fix:** Add config option `audit.required: true/false`. When required, fail startup.

#### 14. No CI pipeline

No `.github/workflows/` or equivalent exists.

**Fix:** Add GitHub Actions: `go vet ./...`, `go test -race ./...`, `make smoke`.

#### 15. `make install` assumes `$GOPATH` is set

**File:** `Makefile:23`

`cp bin/doit $(GOPATH)/bin/doit` — if `GOPATH` is unset, expands to `cp bin/doit /bin/doit`.

**Fix:** `GOPATH ?= $(shell go env GOPATH)` or use `go install ./cmd/doit`.

#### 16. Audit log write errors silently discarded

**File:** `internal/cli/run.go:119`

`_ = logger.Log(...)` — deliberate "best-effort" but means audit failures go unreported.

**Fix:** At minimum, print the error to stderr.

### Low

#### 17-25: See checklist above for brief descriptions.

---

## Dropped Findings (reviewer filtered)

| Finding | Reason |
|---------|--------|
| Registry in context can be absent | Context is always populated by RunDirect/RunPipe before Run() |
| RunDirect hardcodes os.Stderr | Standard for CLI tools; testability is nice-to-have |
| cli/pipe.go is trivial wrappers | Standard package layering pattern |
| splitLines aliasing | Intentional Go slice behavior; safe in current usage |
| Builtin boilerplate duplication | 20-line files; simplest possible implementation |
| main.go ad-hoc flag parsing | Functional for 6 subcommands |
| show/tail aliases | Help correctly lists both |
| cp has no path restrictions | Correct for TierWrite; path restrictions are a separate feature |
| Most capabilities lack arg validation | External commands validate their own args |
| No copyright headers | Not legally required; LICENSE file suffices |
| No NOTICE file | yaml.v3 MIT license doesn't require NOTICE for redistribution |
| No CONTRIBUTING/CLA | Nice-to-have post-release |
| No CLAUDE.md in project root | Agent-private memory exists; CLAUDE.md can come with docs phase |
| No README | Handled in open-source Phase 3 (docs) |
| Tilde expansion only handles `~/` | `~user/` is rare; `~/` is the standard |
| No Windows support | Project targets macOS/Linux per requirements |
| ExecuteCommand shares stdin | Correct behavior; matches shell semantics |
